services:
  # --- Skillbox API Server ---
  api:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile
    ports:
      - "${SKILLBOX_API_PORT:-8080}:8080"
    environment:
      SKILLBOX_DB_DSN: "postgres://skillbox:skillbox@postgres:5432/skillbox?sslmode=disable"
      SKILLBOX_REDIS_URL: "redis://redis:6379/0"
      SKILLBOX_S3_ENDPOINT: "minio:9000"
      SKILLBOX_S3_ACCESS_KEY: "minioadmin"
      SKILLBOX_S3_SECRET_KEY: "minioadmin"
      SKILLBOX_S3_USE_SSL: "false"
      SKILLBOX_DOCKER_HOST: "tcp://docker-proxy:2375"
      SKILLBOX_LOG_LEVEL: "debug"
      SKILLBOX_IMAGE_ALLOWLIST: "python:3.12-slim,python:3.11-slim,node:20-slim,node:18-slim,bash:5"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
      docker-proxy:
        condition: service_started
    networks:
      - backend
      - docker
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/skillbox", "health", "--server", "http://localhost:8080"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # --- PostgreSQL ---
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: skillbox
      POSTGRES_PASSWORD: skillbox
      POSTGRES_DB: skillbox
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U skillbox -d skillbox"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  # --- Redis ---
  redis:
    image: redis:7-alpine
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru

  # --- MinIO (S3-compatible object storage) ---
  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    networks:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 10s
    command: server /data --console-address ":9001"

  # --- MinIO bucket initialization ---
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - backend
    entrypoint: >
      /bin/sh -c "
      mc alias set skillbox http://minio:9000 minioadmin minioadmin;
      mc mb --ignore-existing skillbox/skills;
      mc mb --ignore-existing skillbox/executions;
      echo 'Buckets created successfully';
      "

  # --- Docker Socket Proxy ---
  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    environment:
      CONTAINERS: 1
      IMAGES: 1
      POST: 1
      DELETE: 1
      ALLOW_START: 1
      ALLOW_STOP: 1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - docker
    restart: unless-stopped

  # --- Seed API key into Postgres ---
  # Waits for the API to be healthy (which means migrations are done),
  # then inserts the test API key.
  seed-apikey:
    image: postgres:16-alpine
    depends_on:
      api:
        condition: service_healthy
    networks:
      - backend
    # SHA-256 of "sk-example-test-key" = ab3f17a38b...
    entrypoint:
      - /bin/sh
      - -c
      - |
        PGPASSWORD=skillbox psql -h postgres -U skillbox -d skillbox -c \
          "INSERT INTO sandbox.api_keys (tenant_id, name, key_hash) VALUES ('default', 'example', 'ab3f17a38b9b371a2c75859fd888f39c5b2babf667e59ede2e6b6ab994ebdb20') ON CONFLICT DO NOTHING;" \
        && echo 'API key seeded successfully'

  # --- Example Test Runner ---
  # Uploads example skills and runs them.
  test-runner:
    image: alpine:3.20
    depends_on:
      seed-apikey:
        condition: service_completed_successfully
    networks:
      - backend
    volumes:
      - ./run-examples.sh:/run-examples.sh:ro
      - ./skills:/skills:ro
    entrypoint:
      - /bin/sh
      - -c
      - "apk add --no-cache curl zip > /dev/null 2>&1 && sh /run-examples.sh"

  # --- Python SDK E2E Test Runner ---
  # Runs the Python SDK against the live Skillbox server.
  python-sdk-test:
    image: python:3.12-slim
    depends_on:
      test-runner:
        condition: service_completed_successfully
    networks:
      - backend
    environment:
      SKILLBOX_SERVER_URL: "http://api:8080"
      SKILLBOX_API_KEY: "sk-example-test-key"
    volumes:
      - ../sdks/python/skillbox.py:/sdk/skillbox.py:ro
      - ./python-sdk-e2e.py:/sdk/python-sdk-e2e.py:ro
    working_dir: /sdk
    entrypoint:
      - python
      - python-sdk-e2e.py

networks:
  backend:
    driver: bridge
  docker:
    driver: bridge
    internal: true
